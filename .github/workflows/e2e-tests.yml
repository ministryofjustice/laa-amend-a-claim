name: E2E Tests with Self-Hosted Runner

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: 'main'
      environment:
        required: true
        type: string
      amend_a_claim_image_tag:
        required: true
        type: string
      sanitized_release_name:
        required: true
        type: string
        description: 'Sanitized release name from ephemeral deployment (e.g., my-branch-name).'
      claims_api_image_tag:
        required: false
        type: string
        default: 'd694928c4891a615dd2658abe08d7be41c1db226'
        description: 'data-claims-api image tag, retrieved from github build logs (needs to update with latest version)'
    secrets:
      ECR_ROLE_TO_ASSUME:
        required: true
      DATA_CLAIMS_API_IMAGE:
        required: true
      KUBE_NAMESPACE:
        required: true
      KUBE_CLUSTER:
        required: true
      KUBE_TOKEN:
        required: true
      KUBE_CERT:
        required: true
      E2E_DB_PASSWORD:
        required: true
      E2E_DB_USER:
         required: true

permissions:
  id-token: write
  contents: read

jobs:
  ensure-runner-available:
    name: Ensure GitHub Runner Available
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      deploy-runner: ${{ steps.check-runner.outputs.deploy-runner }}
    env:
      KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
      KUBE_CERT: ${{ secrets.KUBE_CERT }}
      KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
      KUBE_CLUSTER: ${{ secrets.KUBE_CLUSTER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ inputs.branch }}

      - name: Authenticate to Kubernetes Cluster
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/authenticate_to_cluster@768f673017edbb793cf052fa159c272d6c1f9177
        with:
          kube-cert: ${{ secrets.KUBE_CERT }}
          kube-token: ${{ secrets.KUBE_TOKEN }}
          kube-cluster: ${{ secrets.KUBE_CLUSTER }}
          kube-namespace: ${{ secrets.KUBE_NAMESPACE }}
          kube-sa: deploy-user

      - name: Check Runner Pod/Release
        id: check-runner
        run: |
          set +e
          echo "Checking if e2e-github-runner Helm release is deployed and pod is running..."
          helm status e2e-github-runner --namespace ${KUBE_NAMESPACE} > /dev/null 2>&1
          HELM_STATUS=$?
          POD_STATUS=$(kubectl get pods -n ${KUBE_NAMESPACE} -l app=e2e-github-runner -o jsonpath='{.items[0].status.phase}' 2>/dev/null)
          if [ "$HELM_STATUS" -eq 0 ] && [ "$POD_STATUS" = "Running" ]; then
            echo "Runner release and pod are present and running."
            echo "deploy-runner=false" >> $GITHUB_OUTPUT
          else
            echo "Runner not present or not running, will deploy."
            echo "deploy-runner=true" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to ECR
        if: steps.check-runner.outputs.deploy-runner == 'true'
        id: ecr-auth
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@768f673017edbb793cf052fa159c272d6c1f9177
        with:
          ecr_region: ${{ vars.ECR_REGION }}
          ecr_role: ${{ secrets.ECR_ROLE_TO_ASSUME }}
          role-session-name: ${{ github.run_id }}-runner-deploy

      - name: Build and Push Runner Image
        if: steps.check-runner.outputs.deploy-runner == 'true'
        id: build
        uses: docker/build-push-action@v6.18.0
        with:
          context: ./scripts
          file: ./scripts/Dockerfile.e2e-runner
          push: true
          tags: |
            ${{ steps.ecr-auth.outputs.image_registry }}/${{ vars.ECR_REPOSITORY }}:github-runner-${{ github.run_id }}

      - name: Deploy Runner
        if: steps.check-runner.outputs.deploy-runner == 'true'
        env:
          REGISTRY: ${{ steps.ecr-auth.outputs.image_registry }}
          REPOSITORY: ${{ vars.ECR_REPOSITORY }}
        run: |
          echo "Deploying persistent GitHub runner..."
          helm upgrade --install e2e-github-runner ./.helm/github-runner \
            --namespace ${KUBE_NAMESPACE} \
            --set image.repository=${REGISTRY}/${REPOSITORY} \
            --set image.tag=github-runner-${{ github.run_id }} \
            --wait \
            --timeout 5m
          
          echo "Checking runner logs for registration..."
          
          for i in {1..30}; do
            if kubectl logs -l app=e2e-github-runner -n ${KUBE_NAMESPACE} | grep -q "Registered"; then
              echo "Runner logged successful registration."
              break
            fi
            sleep 5
          done

  deploy-e2e-environment:
    name: Deploy E2E Environment
    needs: ensure-runner-available
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
      KUBE_CERT: ${{ secrets.KUBE_CERT }}
      KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
      KUBE_CLUSTER: ${{ secrets.KUBE_CLUSTER }}
      RELEASE_NAME: e2e-${{ inputs.sanitized_release_name }}
      AMEND_CLAIM_UI: e2e-${{ inputs.sanitized_release_name }}-amend-claim
      DATA_CLAIMS_SERVICE: e2e-${{ inputs.sanitized_release_name }}-claims-api
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ inputs.branch }}

      - name: Authenticate to ECR
        id: ecr-auth
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@768f673017edbb793cf052fa159c272d6c1f9177
        with:
          ecr_region: ${{ vars.ECR_REGION }}
          ecr_role: ${{ secrets.ECR_ROLE_TO_ASSUME }}
          role-session-name: ${{ github.run_id }}-e2e-deploy

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4.0.1
        with:
          version: v1.28.0

      - name: Configure kubectl
        run: |
          echo "${KUBE_CERT}" > ca.crt
          kubectl config set-cluster ${KUBE_CLUSTER} --certificate-authority=./ca.crt --server=https://${KUBE_CLUSTER}
          kubectl config set-credentials deploy-user --token=${KUBE_TOKEN}
          kubectl config set-context ${KUBE_CLUSTER} --cluster=${KUBE_CLUSTER} --user=deploy-user --namespace=${KUBE_NAMESPACE}
          kubectl config use-context ${KUBE_CLUSTER}

      - name: Deploy to Cloud Platform with Helm
        env:
          REGISTRY: ${{ steps.ecr-auth.outputs.image_registry }}
          REPOSITORY: ${{ vars.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ inputs.amend_a_claim_image_tag }}
          API_IMAGE: ${{ secrets.DATA_CLAIMS_API_IMAGE }}
          API_IMAGE_TAG: ${{ inputs.claims_api_image_tag }}
          E2E_DB_USER: ${{ secrets.E2E_DB_USER }}
          E2E_DB_PASSWORD: ${{ secrets.E2E_DB_PASSWORD }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          echo "Deploying with release name: ${RELEASE_NAME}"
          echo "Using services: ${AMEND_CLAIM_UI} and ${DATA_CLAIMS_SERVICE}"
          
          helm upgrade --install ${RELEASE_NAME} ./.helm/e2e-stack \
           --namespace ${KUBE_NAMESPACE} \
           --values .helm/e2e-stack/values.yaml \
           --set dataClaimsApi.enabled=true \
           --set dataClaimsApi.image.repository=${API_IMAGE} \
           --set dataClaimsApi.image.tag=${API_IMAGE_TAG} \
           --set dataClaimsApi.postgres.enabled=true \
           --set dataClaimsApi.postgres.user=${E2E_DB_USER} \
           --set dataClaimsApi.postgres.password=${E2E_DB_PASSWORD} \
           --set laaAmendAClaim.enabled=true \
           --set laaAmendAClaim.image.repository=${REGISTRY}/${REPOSITORY} \
           --set laaAmendAClaim.image.tag=${IMAGE_TAG} \
           --set laaAmendAClaim.claimsApiHost=${DATA_CLAIMS_SERVICE} \
           --set redis.enabled=true \
           --wait \
           --timeout 5m

          echo "Helm deployment complete"
          kubectl get pods -n ${KUBE_NAMESPACE}

  run-e2e-tests:
    name: Run E2E Tests
    needs: deploy-e2e-environment
    runs-on: [self-hosted, aabc-e2e-java25]
    env:
      E2E_DB_USER: ${{ secrets.E2E_DB_USER }}
      E2E_DB_PASSWORD: ${{ secrets.E2E_DB_PASSWORD }}
      AMEND_CLAIM_UI: e2e-${{ inputs.sanitized_release_name }}-amend-claim
      DATA_CLAIMS_SERVICE: e2e-${{ inputs.sanitized_release_name }}-claims-api
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5.0.0

      - name: Install Node dependencies
        working-directory: src/e2e
        run: npm install

      - name: Wait for Services
        run: |
          echo "Waiting for services to be ready..."
          check_health() {
            local name=$1
            local url=$2
            local retries=20
            for i in $(seq 1 $retries); do
              echo "check $name (attempt $i of $retries).."
              if curl -sf $url > /dev/null; then
                echo "$name is healthy";
                return 0;
              fi
              sleep 2
            done
            echo "ERROR: $name is not healthy"           
            exit 1
          }          
          check_health "AMEND_CLAIM_UI" "http://${AMEND_CLAIM_UI}:8084/actuator/health"
          check_health "DATA_CLAIMS_SERVICE" "http://${DATA_CLAIMS_SERVICE}:8082/actuator/health"

      - name: Run E2E Tests
        working-directory: src/e2e
        run: |
          export CI=true
          export SILAS_AUTH_ENABLED=false
          export AXE_ENABLED=true
          export ZAP_ENABLED=false
          export DB_USER=${E2E_DB_USER}
          export DB_PASSWORD=${E2E_DB_PASSWORD}
          export UI_BASE_URL=http://${AMEND_CLAIM_UI}:8084 
          export DB_CONNECTION_URL=jdbc:postgresql://${DATA_CLAIMS_SERVICE}:5435/laa_data_claims_api_dev \
          
          echo "Running E2E tests..."
          ./gradlew clean test --no-daemon

      - name: Generate Allure Report
        if: always()
        working-directory: src/e2e
        run: |
          allure generate build/allure-results -o build/allure-report --clean || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: e2e-test-results-${{ github.run_number }}
          path: |
            src/e2e/build/test-results/
            src/e2e/build/reports/
            src/e2e/build/allure-report/
            src/e2e/build/axe-reports/
            src/e2e/build/zap-reports/
          retention-days: 15

