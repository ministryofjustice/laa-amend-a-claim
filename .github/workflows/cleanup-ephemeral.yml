on:
  workflow_dispatch:
  pull_request:
    types: [closed]
  delete:
    branches:
      - '**'

permissions:
  contents: read
  id-token: write

jobs:
  cleanup:
    name: Remove Ephemeral Environment
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6.0.2

      - name: Sanitize Branch Name
        id: sanitize
        uses: ./.github/actions/sanitize-branch-name
        with:
          branch_name: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.event.ref }}
          namespace: ${{ secrets.KUBE_NAMESPACE }}

      - name: Authenticate to Kubernetes Cluster
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/authenticate_to_cluster@768f673017edbb793cf052fa159c272d6c1f9177
        with:
          kube-cert: ${{ secrets.KUBE_CERT }}
          kube-token: ${{ secrets.KUBE_TOKEN }}
          kube-cluster: ${{ secrets.KUBE_CLUSTER }}
          kube-namespace: ${{ secrets.KUBE_NAMESPACE }}
          kube-sa: deploy-user

      - name: Delete Helm Release
        env:
          KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
          RELEASE_NAME: ${{ steps.sanitize.outputs.release_name }}
        run: |
          if helm list -n "${KUBE_NAMESPACE}" | grep -q "${RELEASE_NAME}"; then
            echo "Deleting release: ${RELEASE_NAME}"
            helm uninstall "${RELEASE_NAME}" -n "${KUBE_NAMESPACE}"
            echo "Ephemeral environment cleaned up successfully"
          else
            echo "Release ${RELEASE_NAME} not found, nothing to clean up"
          fi

      - name: Delete E2E ephemeral environment
        env:
          KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
          RELEASE_NAME: ${{ steps.sanitize.outputs.release_name }}
        run: |
          if helm list -n "${KUBE_NAMESPACE}" | grep -q "e2e-${RELEASE_NAME}"; then
            echo "Deleting release: e2e-${RELEASE_NAME}"
            helm uninstall "e2e-${RELEASE_NAME}" -n "${KUBE_NAMESPACE}"
            echo "E2E ephemeral environment cleaned up successfully"
          else
            echo "Release e2e-${RELEASE_NAME} not found, nothing to clean up"
          fi
